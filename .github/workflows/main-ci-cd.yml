# GitHub Actions workflow for main branch continuous integration and deployment
#-----------------------------------------------------------------
name: main-ci-cd

on:
  push:
    branches:
      - main

jobs:
  install:
    name: "ğŸ“¦ Install Dependencies"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ” Checkout"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Set up Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: "ğŸ“¥ Install dependencies"
        run: npm ci

  lint:
    name: "ğŸ” Lint"
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: "ğŸ” Checkout"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Set up Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: "ğŸ“¥ Install dependencies"
        run: npm ci

      - name: "ğŸ§¹ Lint"
        run: npm run lint

  test:
    name: "ğŸ§ª Test (CI)"
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: "ğŸ” Checkout"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Set up Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: "ğŸ“¥ Install dependencies"
        run: npm ci

      - name: "ğŸ§ª Run tests"
        run: npm run test:ci

  security-scan:
    name: "ğŸ›¡ï¸ Security Scan"
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: "ğŸ” Checkout"
        uses: actions/checkout@v4

      - name: "ğŸ” Validate SNYK_TOKEN"
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "âŒ SNYK_TOKEN secret is missing"
            exit 1
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: "ğŸ” Snyk Test (Fail on vulnerabilities)"
        uses: snyk/actions/node@v1
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test

      - name: "ğŸ“Š Snyk Monitor (Send report to dashboard)"
        if: always()
        uses: snyk/actions/node@v1
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor

  build:
    name: "ğŸ—ï¸ Build"
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    steps:
      - name: "ğŸ” Checkout"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Set up Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: "ğŸ“¥ Install dependencies"
        run: npm ci

      - name: "ğŸ—ï¸ Build"
        run: npm run build

      - name: "ğŸ“¦ Upload build artifact"
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

  docker:
    name: "ğŸ³ Build & Push Docker Image"
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: "ğŸ” Checkout"
        uses: actions/checkout@v4

      - name: "ğŸ§© Set up QEMU"
        uses: docker/setup-qemu-action@v2

      - name: "ğŸ§° Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "ğŸ” Log in to Docker Hub"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: "ğŸš€ Build and push Docker image"
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/kudos-app-26thDec:latest
            ${{ secrets.DOCKER_USERNAME }}/kudos-app-26thDec:${{ github.sha }}
# # ------------------------------------------------
#   # 7. Deploy to AWS EC2 (Continuous Deployment)
#   # ------------------------------------------------
#   deploy-ec2:
#     name: "ğŸš€ Deploy to AWS EC2"
#     runs-on: ubuntu-latest
#     needs: docker

#     steps:
#       - name: "ğŸš€ Deploy application on EC2"
#         uses: appleboy/ssh-action@v1
#         with:
#           host: ${{ secrets.EC2_HOST }}
#           username: ${{ secrets.EC2_USER }}
#           key: ${{ secrets.EC2_SSH_KEY }}
#           script: |
#             echo "Pulling latest image..."
#             docker pull ${{ secrets.DOCKER_USERNAME }}/kudos-app-26thDec:latest

#             echo "Stopping old container..."
#             docker stop kudos-app-26thDec || true
#             docker rm kudos-app-26thDec || true

#             echo "Starting new container..."
#             docker run -d \
#               --name kudos-app-26thDec \
#               -p 80:80 \
#               ${{ secrets.DOCKER_USERNAME }}/kudos-app-26thDec:latest